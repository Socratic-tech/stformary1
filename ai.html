<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Vector Silhouette</title>
    <script src="https://cdn.jsdelivr.net/npm/imagetracerjs@1.2.6/imagetracer_v1.2.6.min.js"></script>
    
    <style>
        :root { --primary: #2563eb; --accent: #8b5cf6; --bg: #f8fafc; --card: #ffffff; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: #333; display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        
        h1 { margin-bottom: 5px; }
        p { color: #64748b; margin-bottom: 25px; text-align: center; max-width: 600px; line-height: 1.5; }
        
        .container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; width: 100%; max-width: 1100px; align-items: flex-start; }
        
        .card { background: var(--card); padding: 25px; border-radius: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        
        /* Canvas Container */
        .preview-area { flex: 2; min-width: 300px; align-items: center; position: relative; }
        canvas { max-width: 100%; height: auto; border: 1px solid #e2e8f0; border-radius: 8px; background-image: linear-gradient(45deg, #eee 25%, transparent 25%), linear-gradient(-45deg, #eee 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #eee 75%), linear-gradient(-45deg, transparent 75%, #eee 75%); background-size: 20px 20px; }
        
        /* Controls */
        .controls-area { flex: 1; min-width: 280px; max-width: 350px; }
        
        .control-group { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f1f5f9; }
        .control-group:last-child { border-bottom: none; }
        
        label { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-weight: 600; font-size: 0.95rem; cursor: pointer; }
        input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary); }
        input[type="range"] { width: 100%; cursor: pointer; accent-color: var(--primary); }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-upload { background: #e2e8f0; color: #334155; margin-bottom: 10px; }
        .btn-upload:hover { background: #cbd5e1; }
        
        .btn-ai { background: linear-gradient(135deg, #8b5cf6, #d946ef); color: white; margin-bottom: 20px; border: 1px solid transparent; }
        .btn-ai:hover { opacity: 0.9; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3); }
        .btn-ai:disabled { background: #ccc; cursor: not-allowed; opacity: 0.7; }

        /* Download Buttons Grid */
        .download-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        
        .btn-dl { color: white; opacity: 0.5; pointer-events: none; font-size: 0.9rem; }
        .btn-dl:not([disabled]) { opacity: 1; pointer-events: auto; }
        
        .btn-png { background: var(--primary); }
        .btn-png:hover { background: #1d4ed8; }
        
        .btn-svg { background: #059669; }
        .btn-svg:hover { background: #047857; }

        #fileInput { display: none; }
        
        /* Loading Overlay */
        .loading-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; border-radius: 8px; display: none; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Error Message */
        .error-msg { color: #dc2626; font-size: 0.9rem; margin-top: 10px; text-align: center; max-width: 80%; display: none; }
    </style>
</head>
<body>

    <h1>ðŸ‘¤ AI Vector Silhouette</h1>
    <p>Upload a photo. Generate <strong>PNG</strong> or <strong>Scalable SVG</strong> shadows instantly.</p>

    <div class="container">
        
        <div class="card controls-area">
            <button class="btn btn-upload" onclick="document.getElementById('fileInput').click()">
                ðŸ“‚ Upload Photo
            </button>
            <input type="file" id="fileInput" accept="image/*">

            <button id="aiBtn" class="btn btn-ai" disabled>
                âœ¨ AI Remove Background
            </button>

            <div class="control-group">
                <label>Threshold <span style="font-weight:normal; font-size:0.8em; color:#666;">(Manual Mode)</span></label>
                <input type="range" id="threshold" min="0" max="255" value="128">
            </div>

            <div class="control-group">
                <label>Cameo Tools</label>
                <label style="font-weight: normal;"><input type="checkbox" id="flip"> Flip Direction</label>
                <label style="font-weight: normal;"><input type="checkbox" id="oval"> Oval Frame</label>
                <label style="font-weight: normal;"><input type="checkbox" id="invert"> Invert (White Shadow)</label>
            </div>

            <div class="download-group">
                <button id="dlPng" class="btn btn-dl btn-png" disabled>â¬‡ PNG</button>
                <button id="dlSvg" class="btn btn-dl btn-svg" disabled>â¬‡ SVG</button>
            </div>
        </div>

        <div class="card preview-area">
            <div id="loader" class="loading-overlay">
                <div class="spinner"></div>
                <div id="loadingText" style="text-align:center;">Initializing AI...<br><span style="font-size:0.8em; color:#666;">(First run takes ~15s)</span></div>
                <div id="errorText" class="error-msg"></div>
            </div>
            <canvas id="canvas"></canvas>
        </div>
    </div>

    <script type="module">
        // 1. FIXED IMPORT: Points explicitly to version 1.7.0 to match the assets
        import { removeBackground } from "https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.7.0/+esm";

        const fileInput = document.getElementById('fileInput');
        const aiBtn = document.getElementById('aiBtn');
        const thresholdSlider = document.getElementById('threshold');
        const flipCheck = document.getElementById('flip');
        const ovalCheck = document.getElementById('oval');
        const invertCheck = document.getElementById('invert');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const dlPng = document.getElementById('dlPng');
        const dlSvg = document.getElementById('dlSvg');
        const loader = document.getElementById('loader');
        const loadingText = document.getElementById('loadingText');
        const errorText = document.getElementById('errorText');

        let currentImg = new Image();
        let originalUploadedImg = null;
        let isLoaded = false;
        let isAiProcessed = false;

        // --- 2. Configuration for GitHub Pages ---
        // We must tell the AI where to find the 'brain' (wasm files) on the public internet
        const aiConfig = {
            publicPath: "https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.7.0/dist/",
            debug: true, // This allows us to see errors in the browser console
            model: 'small' // Use the smaller model for faster loading
        };

        // Handle Image Upload
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    originalUploadedImg = img;
                    currentImg = img;
                    isLoaded = true;
                    isAiProcessed = false;
                    enableButtons();
                    thresholdSlider.value = 128;
                    
                    // Reset UI
                    loader.style.display = 'none';
                    errorText.style.display = 'none';
                    
                    processImage();
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(file);
        });

        function enableButtons() {
            dlPng.disabled = false;
            dlSvg.disabled = false;
            aiBtn.disabled = false;
        }

        // Handle AI Background Removal
        aiBtn.addEventListener('click', async () => {
            if (!originalUploadedImg) return;
            
            // UI Update
            loader.style.display = 'flex';
            errorText.style.display = 'none';
            aiBtn.disabled = true;
            loadingText.innerHTML = "Downloading AI Model...<br><span style='font-size:0.8em; color:#666;'>(This happens once)</span>";

            try {
                // Call the AI with our specific config
                const blob = await removeBackground(originalUploadedImg.src, aiConfig);
                const url = URL.createObjectURL(blob);
                
                const aiImg = new Image();
                aiImg.onload = () => {
                    currentImg = aiImg;
                    isAiProcessed = true;
                    loader.style.display = 'none';
                    aiBtn.disabled = false;
                    processImage();
                }
                aiImg.src = url;
            } catch (error) {
                console.error("AI FAILED:", error);
                
                // Show user friendly error
                loader.style.display = 'flex'; // Keep overlay up but show error
                loadingText.style.display = 'none';
                document.querySelector('.spinner').style.display = 'none';
                
                errorText.style.display = 'block';
                errorText.innerHTML = `<strong>AI Error:</strong><br>${error.message}<br><br><button onclick="location.reload()" style="padding:5px;">Reload Page</button>`;
                
                aiBtn.disabled = false;
            }
        });

        // Rendering Pipeline
        function processImage() {
            if (!isLoaded) return;
            canvas.width = currentImg.width;
            canvas.height = currentImg.height;
            const w = canvas.width;
            const h = canvas.height;

            // A. Draw Base
            ctx.save();
            ctx.clearRect(0, 0, w, h);
            
            if (ovalCheck.checked) {
                ctx.beginPath();
                ctx.ellipse(w/2, h/2, w/2, h/2, 0, 0, 2 * Math.PI);
                ctx.clip();
            }

            if (flipCheck.checked) {
                ctx.translate(w, 0);
                ctx.scale(-1, 1);
            }

            ctx.drawImage(currentImg, 0, 0);
            ctx.restore();

            // B. Convert to Silhouette
            const frame = ctx.getImageData(0, 0, w, h);
            const data = frame.data;
            const thresh = parseInt(thresholdSlider.value);
            const isInverted = invertCheck.checked;

            for (let i = 0; i < data.length; i += 4) {
                const alpha = data[i+3];
                if (alpha === 0) continue; // Skip transparent

                let isSubject = false;
                if (isAiProcessed) {
                    // For AI result, if it's visible, it's the person
                    if (alpha > 50) isSubject = true;
                } else {
                    // Manual brightness check
                    const brightness = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
                    if (isInverted ? brightness > thresh : brightness < thresh) isSubject = true;
                }

                if (isSubject) {
                    const c = isInverted ? 255 : 0;
                    data[i] = c; data[i+1] = c; data[i+2] = c; data[i+3] = 255;
                } else {
                    data[i+3] = 0;
                }
            }
            ctx.putImageData(frame, 0, 0);
        }

        // Listeners
        [thresholdSlider, flipCheck, ovalCheck, invertCheck].forEach(el => {
            el.addEventListener('input', processImage);
        });

        dlPng.addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'silhouette.png';
            link.href = canvas.toDataURL();
            link.click();
        });

        dlSvg.addEventListener('click', () => {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const options = { ltres: 1, qtres: 1, pathomit: 8, colorsampling: 0, numberofcolors: 2, mincolorratio: 0, colorquantcycles: 0 };
            const svgStr = window.ImageTracer.imagedataToSVG(imageData, options);
            const blob = new Blob([svgStr], { type: "image/svg+xml;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = 'silhouette.svg';
            link.href = url;
            link.click();
        });
    </script>
</body>
</html>
