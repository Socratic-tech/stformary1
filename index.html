<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silhouette Studio: Paper Cut</title>
    <script src="https://cdn.jsdelivr.net/gh/jankovicsandras/imagetracerjs@1.2.5/imagetracer_v1.2.5.js"></script>
    
    <style>
        :root { --primary: #3b82f6; --bg: #f8fafc; --card: #ffffff; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: #334155; display: flex; flex-direction: column; align-items: center; padding: 30px 20px; margin: 0; }
        
        h1 { margin-bottom: 5px; color: #0f172a; }
        p { color: #64748b; margin-bottom: 35px; text-align: center; max-width: 600px; line-height: 1.5; }
        
        .container { display: flex; flex-wrap: wrap; gap: 25px; justify-content: center; width: 100%; max-width: 1200px; align-items: flex-start; }
        
        .card { background: var(--card); padding: 25px; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        
        /* Canvas */
        .preview-area { flex: 2; min-width: 320px; align-items: center; }
        canvas { max-width: 100%; height: auto; border: 1px solid #e2e8f0; border-radius: 8px; background-image: linear-gradient(45deg, #eee 25%, transparent 25%), linear-gradient(-45deg, #eee 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #eee 75%), linear-gradient(-45deg, transparent 75%, #eee 75%); background-size: 20px 20px; }
        
        /* Controls */
        .controls-area { flex: 1; min-width: 300px; max-width: 380px; }
        
        .section-header { background: #f1f5f9; padding: 10px 15px; border-radius: 8px; margin-bottom: 15px; font-weight: 700; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; color: #475569; }
        .control-group { margin-bottom: 25px; }
        
        label { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; }
        input[type="range"] { width: 100%; cursor: pointer; accent-color: var(--primary); margin-bottom: 5px; }
        input[type="color"] { border: 1px solid #e2e8f0; border-radius: 4px; width: 50px; height: 30px; cursor: pointer; background: none; padding: 2px;}
        input[type="checkbox"] { accent-color: var(--primary); width: 16px; height: 16px; cursor: pointer; }

        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; transition: 0.2s; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-upload { background: #eff6ff; color: #1d4ed8; border: 1px dashed #bfdbfe; margin-bottom: 25px; }
        .btn-upload:hover { background: #dbeafe; border-color: #3b82f6; }
        
        .download-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
        .btn-dl { color: white; opacity: 0.5; pointer-events: none; }
        .btn-dl:not([disabled]) { opacity: 1; pointer-events: auto; }
        .btn-png { background: #334155; } .btn-png:hover { background: #1e293b; }
        .btn-svg { background: #059669; } .btn-svg:hover { background: #047857; }

        #fileInput { display: none; }
        .val-badge { background: #e2e8f0; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; font-weight: normal; }
        
        /* Highlight for the new feature */
        .highlight-option { background: #fff7ed; border: 1px solid #ffedd5; padding: 12px; border-radius: 8px; margin-bottom: 15px; }
        
        /* Puppet Stick sub-controls */
        #rodControls { margin-top: 10px; padding-top: 10px; border-top: 1px solid #fed7aa; display: none; }
    </style>
</head>
<body>

    <h1>Silhouette Studio: Paper Cut</h1>
    <p>Turn photos into <strong>Paper Cutouts</strong> on a backlit screen.</p>

    <div class="container">
        
        <div class="card controls-area">
            <button class="btn btn-upload" onclick="document.getElementById('fileInput').click()">
                ðŸ“‚ Upload Photo
            </button>
            <input type="file" id="fileInput" accept="image/*">

            <div class="control-group">
                <div class="section-header">1. Clean Up Image</div>
                <label>Contrast Boost <span class="val-badge" id="contrastVal">0%</span></label>
                <input type="range" id="contrast" min="0" max="200" value="0">
                
                <label>Edge Smoothing <span class="val-badge" id="blurVal">0px</span></label>
                <input type="range" id="blur" min="0" max="5" value="0.5" step="0.5">
            </div>

            <div class="control-group">
                <div class="section-header">2. Create Solid Fill</div>
                <label>Threshold (Cutoff) <span class="val-badge" id="threshVal">128</span></label>
                <input type="range" id="threshold" min="0" max="255" value="128">

                <div style="display:flex; justify-content:space-between; margin-top:15px; align-items:center;">
                    <label style="font-weight:normal; margin:0;"><input type="checkbox" id="invert"> Invert Color</label>
                    <input type="color" id="colorPicker" value="#1a1a1a" title="Paper Color">
                </div>
            </div>

            <div class="control-group">
                <div class="section-header">3. Paper Cut FX</div>
                
                <div class="highlight-option">
                    <label style="margin:0; color:#9a3412; cursor:pointer;">
                        <span style="display:flex; align-items:center; gap:8px;">
                            <input type="checkbox" id="paperMode" checked> 
                            <strong>Paper Cut Mode</strong>
                        </span>
                    </label>
                    <div style="font-size:0.75rem; color:#c2410c; margin-top:5px; margin-left:24px; line-height:1.3;">
                        Adds backlit screen, construction paper texture, and sharp edges.
                    </div>
                </div>

                <div class="highlight-option" style="background:#f0fdf4; border-color:#bbf7d0;">
                    <label style="margin:0; color:#166534; cursor:pointer;">
                        <span style="display:flex; align-items:center; gap:8px;">
                            <input type="checkbox" id="addStick"> 
                            <strong>Add Puppet Rod</strong>
                        </span>
                    </label>
                    
                    <div id="rodControls">
                        <label style="color:#166534; font-size:0.8rem;">Rod Position</label>
                        <input type="range" id="rodPos" min="0" max="100" value="50">
                    </div>
                </div>

                <div style="display: flex; gap: 15px; margin-top: 15px;">
                    <label style="font-weight:normal"><input type="checkbox" id="flip"> Flip Horiz.</label>
                    <label style="font-weight:normal"><input type="checkbox" id="oval"> Oval Crop</label>
                </div>
            </div>

            <div class="download-group">
                <button id="dlPng" class="btn btn-dl btn-png" disabled>â¬‡ PNG (Image)</button>
                <button id="dlSvg" class="btn btn-dl btn-svg" disabled>â¬‡ SVG (Vector)</button>
            </div>
        </div>

        <div class="card preview-area">
            <canvas id="canvas"></canvas>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const contrastSlider = document.getElementById('contrast');
        const blurSlider = document.getElementById('blur');
        const thresholdSlider = document.getElementById('threshold');
        const colorPicker = document.getElementById('colorPicker');
        const flipCheck = document.getElementById('flip');
        const ovalCheck = document.getElementById('oval');
        const invertCheck = document.getElementById('invert');
        
        // FX
        const paperModeCheck = document.getElementById('paperMode');
        const addStickCheck = document.getElementById('addStick');
        const rodPosSlider = document.getElementById('rodPos');
        const rodControls = document.getElementById('rodControls');

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const dlPng = document.getElementById('dlPng');
        const dlSvg = document.getElementById('dlSvg');

        // --- Paper Texture Generator ---
        // Generates a grainy cardstock noise pattern
        let patternCanvas = document.createElement('canvas');
        patternCanvas.width = 200;
        patternCanvas.height = 200;
        let pCtx = patternCanvas.getContext('2d');
        function generatePaperNoise(colorHex) {
            pCtx.clearRect(0,0,200,200);
            pCtx.fillStyle = colorHex;
            pCtx.fillRect(0,0,200,200);
            
            // Add Grain
            for (let i = 0; i < 10000; i++) {
                const x = Math.random() * 200;
                const y = Math.random() * 200;
                // Add tiny variations (light and dark) to simulate fiber
                pCtx.fillStyle = Math.random() > 0.5 ? "rgba(255,255,255,0.15)" : "rgba(0,0,0,0.1)";
                pCtx.fillRect(x, y, 1.5, 1.5);
            }
        }
        generatePaperNoise("#1a1a1a");

        function updateBadges() {
            document.getElementById('contrastVal').innerText = contrastSlider.value + '%';
            document.getElementById('blurVal').innerText = blurSlider.value + 'px';
            document.getElementById('threshVal').innerText = thresholdSlider.value;
            rodControls.style.display = addStickCheck.checked ? 'block' : 'none';
        }

        let currentImg = new Image();
        let isLoaded = false;

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    currentImg = img;
                    isLoaded = true;
                    dlPng.disabled = false;
                    dlSvg.disabled = false;
                    // Paper Cut Defaults
                    thresholdSlider.value = 128;
                    contrastSlider.value = 25;
                    blurSlider.value = 0.5; // Very low blur for Sharp paper edges
                    updateBadges();
                    processImage();
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(file);
        });

        // --- MAIN RENDERER ---
        function processImage() {
            if (!isLoaded) return;
            
            canvas.width = currentImg.width;
            canvas.height = currentImg.height;
            const w = canvas.width;
            const h = canvas.height;
            const isPaperMode = paperModeCheck.checked;

            // 1. Create Threshold Mask (Temp Canvas)
            const tempCvs = document.createElement('canvas');
            tempCvs.width = w;
            tempCvs.height = h;
            const tCtx = tempCvs.getContext('2d');

            tCtx.save();
            if (ovalCheck.checked) {
                tCtx.beginPath(); tCtx.ellipse(w/2, h/2, w/2, h/2, 0, 0, 2 * Math.PI); tCtx.clip();
            }
            if (flipCheck.checked) {
                tCtx.translate(w, 0); tCtx.scale(-1, 1);
            }
            const contrast = 100 + parseInt(contrastSlider.value);
            const blur = parseFloat(blurSlider.value); 
            tCtx.filter = `contrast(${contrast}%) blur(${blur}px)`;
            tCtx.drawImage(currentImg, 0, 0);
            tCtx.restore();

            // Thresholding
            const frame = tCtx.getImageData(0, 0, w, h);
            const data = frame.data;
            const thresh = parseInt(thresholdSlider.value);
            const isInverted = invertCheck.checked;

            for (let i = 0; i < data.length; i += 4) {
                const alpha = data[i+3];
                if (alpha === 0) continue; 
                const brightness = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
                let isSubject = false;

                if (isInverted) { if (brightness > thresh) isSubject = true; } 
                else { if (brightness < thresh) isSubject = true; }

                if (isSubject) {
                    data[i] = 0; data[i+1] = 0; data[i+2] = 0; data[i+3] = 255; // Solid Black Mask
                } else {
                    data[i+3] = 0; // Transparent
                }
            }
            tCtx.putImageData(frame, 0, 0);

            // 2. Final Composition
            ctx.clearRect(0, 0, w, h);

            if (isPaperMode) {
                // Layer A: Backlight Screen
                // Warm center, slightly darker corners
                const gradient = ctx.createRadialGradient(w/2, h/2, w/4, w/2, h/2, w);
                gradient.addColorStop(0, "#fffef5"); // Center (Bright Warm)
                gradient.addColorStop(1, "#e6e1d5"); // Corners (Shadowy Screen)
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, w, h);
            }

            // Layer B: The Puppet Rod (Must go BEHIND the puppet)
            if (addStickCheck.checked) {
                const rodX = (rodPosSlider.value / 100) * w;
                ctx.beginPath();
                ctx.moveTo(rodX, h); // Start at bottom
                // Draw up to middle of screen (ish)
                ctx.lineTo(rodX, h * 0.4); 
                
                // Styling the rod to look like a dowel/stick
                ctx.lineWidth = w * 0.015; // Responsive width
                ctx.lineCap = "round";
                ctx.strokeStyle = "#111";
                ctx.stroke();
            }

            // Layer C: The Silhouette (Textured)
            if (isPaperMode) {
                // Update noise color to match user selection
                generatePaperNoise(colorPicker.value);
                const pattern = ctx.createPattern(patternCanvas, 'repeat');
                
                // Composite Logic:
                // 1. Draw the Black Mask (from Temp Canvas)
                ctx.drawImage(tempCvs, 0, 0);
                
                // 2. Composite the Pattern ONLY where the mask exists
                ctx.globalCompositeOperation = "source-in";
                ctx.fillStyle = pattern;
                ctx.fillRect(0, 0, w, h);
                
                // 3. Reset composite
                ctx.globalCompositeOperation = "source-over";

            } else {
                // Standard mode: Just fill with solid color
                // We need to re-color the temp canvas because it's black currently
                // Hack: Just draw the mask and apply globalComposite "source-in" with solid color
                ctx.drawImage(tempCvs, 0, 0);
                ctx.globalCompositeOperation = "source-in";
                ctx.fillStyle = colorPicker.value;
                ctx.fillRect(0,0,w,h);
                ctx.globalCompositeOperation = "source-over";
            }
        }

        // Listeners
        const controls = [contrastSlider, blurSlider, thresholdSlider, colorPicker, flipCheck, ovalCheck, invertCheck, paperModeCheck, addStickCheck, rodPosSlider];
        controls.forEach(el => el.addEventListener('input', () => {
            updateBadges();
            processImage();
        }));

        // Downloads
        dlPng.addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'paper-cut-puppet.png';
            link.href = canvas.toDataURL();
            link.click();
        });

        dlSvg.addEventListener('click', () => {
            // SVG logic: We trace the mask (tempCvs logic). 
            // Stick and background are excluded from SVG (usually desirable for cutting machines)
            const tempCvs = document.createElement('canvas');
            tempCvs.width = canvas.width;
            tempCvs.height = canvas.height;
            const tCtx = tempCvs.getContext('2d');
            
            // Re-run threshold logic for clean trace
            tCtx.save();
            if (ovalCheck.checked) { tCtx.beginPath(); tCtx.ellipse(canvas.width/2, canvas.height/2, canvas.width/2, canvas.height/2, 0, 0, 2 * Math.PI); tCtx.clip(); }
            if (flipCheck.checked) { tCtx.translate(canvas.width, 0); tCtx.scale(-1, 1); }
            const contrast = 100 + parseInt(contrastSlider.value);
            const blur = parseFloat(blurSlider.value); 
            tCtx.filter = `contrast(${contrast}%) blur(${blur}px)`;
            tCtx.drawImage(currentImg, 0, 0);
            tCtx.restore();

            const frame = tCtx.getImageData(0, 0, canvas.width, canvas.height);
            const data = frame.data;
            const thresh = parseInt(thresholdSlider.value);
            const isInverted = invertCheck.checked;
            for (let i = 0; i < data.length; i += 4) {
                 if (data[i+3] === 0) continue;
                 const brightness = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
                 let isSubject = (isInverted) ? (brightness > thresh) : (brightness < thresh);
                 if (isSubject) {
                     data[i] = 0; data[i+1] = 0; data[i+2] = 0; data[i+3] = 255;
                 } else {
                     data[i+3] = 0;
                 }
             }
             tCtx.putImageData(frame, 0, 0);

            const imageData = tCtx.getImageData(0, 0, canvas.width, canvas.height);
            const options = { ltres: 1, qtres: 1, pathomit: 8, colorsampling: 0, numberofcolors: 2, mincolorratio: 0, colorquantcycles: 0 };
            const svgStr = window.ImageTracer.imagedataToSVG(imageData, options);

            const blob = new Blob([svgStr], { type: "image/svg+xml;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = 'paper-cut.svg';
            link.href = url;
            link.click();
        });

        updateBadges();
    </script>
</body>
</html>
